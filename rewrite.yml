---
type: specs.openrewrite.org/v1beta/recipe
name: org.goafabric.java.spring.boot4.UpgradeSpringBoot_4_0
recipeList:
  # upgrade spring dependency
  - org.openrewrite.gradle.plugins.UpgradePluginVersion:
      pluginIdPattern: org.springframework.boot
      newVersion: 4.0.0-M1

  # add new starters with autoconfig
  - org.openrewrite.gradle.AddDependency:
      groupId: org.springframework.boot
      artifactId: spring-boot-starter-opentelemetry
      version: 4.0.0-M1
      configuration: implementation

  - org.openrewrite.gradle.AddDependency:
      groupId: org.springframework.boot
      artifactId: spring-boot-starter-flyway
      configuration: implementation
      onlyIfUsing: org.flywaydb.core.Flyway

  - org.openrewrite.gradle.AddDependency:
      groupId: org.springframework.boot
      artifactId: spring-boot-starter-restclient
      configuration: implementation
      onlyIfUsing: org.springframework.web.client.support.RestClientAdapter

  # update packages
  - org.openrewrite.java.ChangePackage:
      oldPackageName: org.springframework.boot.autoconfigure.flyway
      newPackageName: org.springframework.boot.flyway.autoconfigure

  - org.openrewrite.java.ChangePackage:
      oldPackageName: org.springframework.boot.autoconfigure.orm.jpa
      newPackageName: org.springframework.boot.hibernate.autoconfigure

  - org.openrewrite.java.ChangePackage:
      oldPackageName: org.springframework.boot.test.web.server
      newPackageName: org.springframework.boot.web.server.test

  # fix deprecations
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.test.mock.mockito.MockBean
      newFullyQualifiedTypeName: org.springframework.test.context.bean.override.mockito.MockitoBean

  # remove incompatible dependencies
  - org.openrewrite.gradle.RemoveDependency:
      groupId: net.ttddyy.observation
      artifactId: datasource-micrometer-spring-boot

  # deactivate springdoc kotlin support for now
  - org.openrewrite.yaml.MergeYaml:
      filePattern: src/main/resources/application.yml
      key: $
      yaml: |
        springdoc.enable-kotlin: false

  #
  - org.openrewrite.java.CreateSourceFile:
      className: Hibernate7ReflectionConfiguration
      packageName: org.goafabric
      source: |
        import org.springframework.context.annotation.Configuration;
        import org.graalvm.nativeimage.hosted.RegisterReflection;
        import org.graalvm.nativeimage.hosted.MemberCategory;

        @RegisterReflection(
            classes = {
                org.hibernate.boot.model.relational.ColumnOrderingStrategyStandard.class,
                org.hibernate.boot.models.annotations.internal.CacheAnnotation.class,
                org.hibernate.annotations.DialectOverride.class,
                org.hibernate.boot.models.DialectOverrideAnnotations.class,
                org.hibernate.validator.internal.util.logging.Log_$logger.class,
                org.hibernate.engine.internal.VersionLogger_$logger.class,
                org.hibernate.internal.SessionFactoryRegistryMessageLogger_$logger.class,
                org.hibernate.dialect.type.PostgreSQLInetJdbcType.class,
                org.hibernate.dialect.type.PostgreSQLIntervalSecondJdbcType.class,
                org.hibernate.dialect.type.PostgreSQLStructPGObjectJdbcType.class,
                org.hibernate.dialect.type.PostgreSQLJsonPGObjectJsonbType.class,
                org.hibernate.dialect.type.PostgreSQLJsonArrayPGObjectJsonbJdbcTypeConstructor.class
            },
            memberCategories = {
                MemberCategory.INVOKE_DECLARED_CONSTRUCTORS,
                MemberCategory.INVOKE_DECLARED_METHODS,
                MemberCategory.ACCESS_DECLARED_FIELDS
            }
        )
        @Configuration
        public class Hibernate7ReflectionConfiguration {}
        

  # Fix the InjectedExeOps / Dependencies mess left behind
  - org.openrewrite.text.FindAndReplace:
      find: 'interface InjectedExecOps { @get:Inject val execOps: ExecOperations'
      replace: 'interface InjectedExecOps { @get:Inject val execOps: ExecOperations }'
      filePattern: 'build.gradle.kts'

  - org.openrewrite.text.FindAndReplace:
      find: '\n\}\s*\}\s*\ntasks\.'
      replace: |
        
        }
        tasks.
      regex: true
      filePattern: 'build.gradle.kts'
