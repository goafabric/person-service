---
type: specs.openrewrite.org/v1beta/recipe
name: UpgradeSpringBoot_4_0
recipeList:
  # upgrade spring dependency
  - org.openrewrite.gradle.plugins.UpgradePluginVersion:
      pluginIdPattern: org.springframework.boot
      newVersion: 4.0.0-RC1

  - org.openrewrite.gradle.plugins.UpgradePluginVersion:
      pluginIdPattern: org.hibernate.orm
      newVersion: 7.1.1.Final

  # add new starters with autoconfig
  - org.openrewrite.gradle.AddDependency:
      groupId: org.springframework.boot
      artifactId: spring-boot-starter-opentelemetry
      configuration: implementation

  - org.openrewrite.gradle.AddDependency:
      groupId: org.springframework.boot
      artifactId: spring-boot-starter-restclient
      configuration: implementation
#      onlyIfUsing: org.springframework.web.client.support.RestClientAdapter

  # remove dependencies
  - org.openrewrite.gradle.RemoveDependency:
      groupId: io.micrometer
      artifactId: micrometer-tracing-bridge-otel

  - org.openrewrite.gradle.RemoveDependency:
      groupId: io.opentelemetry
      artifactId: opentelemetry-exporter-otlp

  # dependency changes
  - org.openrewrite.gradle.ChangeDependency:
      oldGroupId: org.flywaydb
      oldArtifactId: flyway-core
      newGroupId: org.springframework.boot
      newArtifactId: spring-boot-starter-flyway

  - org.openrewrite.gradle.ChangeDependency:
      oldGroupId: org.springframework.boot
      oldArtifactId: spring-boot-starter-aop
      newGroupId: org.springframework.boot
      newArtifactId: spring-boot-starter-aspectj

  - org.openrewrite.gradle.ChangeDependency:
      oldGroupId: org.springframework.kafka
      oldArtifactId: spring-kafka
      newGroupId: org.springframework.boot
      newArtifactId: spring-boot-starter-kafka

#  # upgrade depencies
#  - org.openrewrite.gradle.UpgradeDependencyVersion:
#      groupId: net.ttddyy.observation
#      artifactId: datasource-micrometer-spring-boot
#      newVersion: 2.0.0-RC1


  # disable incompatible dependency
  - org.openrewrite.text.FindAndReplace:
      filePattern: 'build.gradle.kts'
      find: 'implementation("net.ttddyy.observation:datasource-micrometer-spring-boot'
      replace: '//implementation("net.ttddyy.observation:datasource-micrometer-spring-boot'

  # Spring Boot Imports
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.flyway.FlywayMigrationStrategy
      newFullyQualifiedTypeName: org.springframework.boot.flyway.autoconfigure.FlywayMigrationStrategy

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.flyway.FlywayConfigurationCustomizer
      newFullyQualifiedTypeName: org.springframework.boot.flyway.autoconfigure.FlywayConfigurationCustomizer

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.orm.jpa.HibernatePropertiesCustomizer
      newFullyQualifiedTypeName: org.springframework.boot.hibernate.autoconfigure.HibernatePropertiesCustomizer

#  - org.openrewrite.java.ChangeType:
#      oldFullyQualifiedTypeName: org.springframework.boot.test.web.server.LocalServerPort
#      newFullyQualifiedTypeName: org.springframework.boot.web.server.test.LocalServerPort

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.test.web.client.TestRestTemplate
      newFullyQualifiedTypeName: org.springframework.boot.web.server.test.client.TestRestTemplate

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.web.client.RestTemplateBuilder
      newFullyQualifiedTypeName: org.springframework.boot.restclient.RestTemplateBuilder

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
      newFullyQualifiedTypeName: org.springframework.boot.data.redis.autoconfigure.RedisAutoConfiguration

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.domain.EntityScan
      newFullyQualifiedTypeName: org.springframework.boot.persistence.autoconfigure.EntityScan

  # Kafka Imports
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.actuate.health.Health
      newFullyQualifiedTypeName: org.springframework.boot.health.contributor.Health

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.actuate.health.HealthIndicator
      newFullyQualifiedTypeName: org.springframework.boot.health.contributor.HealthIndicator

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration
      newFullyQualifiedTypeName: org.springframework.boot.kafka.autoconfigure.KafkaAutoConfiguration

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.kafka.KafkaProperties
      newFullyQualifiedTypeName: org.springframework.boot.kafka.autoconfigure.KafkaProperties

  - org.openrewrite.java.RemoveAnnotationAttribute:
      annotationType: org.springframework.kafka.test.context.EmbeddedKafka
      attributeName: brokerProperties

  # elastic
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchClientAutoConfiguration
      newFullyQualifiedTypeName: org.springframework.boot.elasticsearch.autoconfigure.ElasticsearchClientAutoConfiguration

  # fix deprecations
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.boot.test.mock.mockito.MockBean
      newFullyQualifiedTypeName: org.springframework.test.context.bean.override.mockito.MockitoBean

  - org.openrewrite.text.FindAndReplace:
      find: 'MemberCategory.DECLARED_CLASSES,'
      replace: ''
      filePattern: '**/*.java;**/*.kt'

  - org.openrewrite.text.FindAndReplace:
      find: 'MemberCategory.DECLARED_FIELDS'
      replace: 'MemberCategory.ACCESS_DECLARED_FIELDS'
      filePattern: '**/*.java;**/*.kt'

  # deactivate springdoc kotlin support for now
  - org.openrewrite.yaml.MergeYaml:
      filePattern: src/main/resources/application.yml
      key: $
      yaml: |
        springdoc.enable-kotlin: false

  # shut of disconnected otel
  - org.openrewrite.yaml.MergeYaml:
      filePattern: src/main/resources/application.yml
      key: $
      yaml: |
        logging.level.io.micrometer.registry.otlp: "OFF"    

  # Kotlin
  - org.openrewrite.text.FindAndReplace:
      find: 'ResponseEntity<String?>'
      replace: 'ResponseEntity<String>'
      filePattern: '**/*.kt'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'SpringApplication\.exit\((applicationContext|context)'
      replace: 'SpringApplication.exit($1!!'
      regex: true

  - org.openrewrite.text.FindAndReplace:
      find: 'override fun run(vararg args: String?)'
      replace: 'override fun run(vararg args: String)'
      filePattern: '**/*.kt'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: '\.(findById(?:OrNull)?)\(([A-Za-z0-9_.]+)\)'
      replace: '.$1($2!!)'
      regex: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'Repository<T>'
      replace: 'Repository<T : Any>'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'createClient\(adapterType(!!)?\)'
      replace: 'createClient(adapterType$1 as Class<A & Any>)'
      regex: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'attributes: MutableMap<String?, Any?>'
      replace: 'attributes: MutableMap<String, Any>'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: '(hibernateProperties|properties): MutableMap<String\?, Any\?>'
      replace: '$1: MutableMap<String, Any>'
      regex: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: ': SqlStatementInspector?)'
      replace: ': SqlStatementInspector)'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'private inline fun <reified T> ApplicationContext.getBean()'
      replace: 'private inline fun <reified T : Any> ApplicationContext.getBean()'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'factory.consumerFactory = DefaultKafkaConsumerFactory(latestConsumerConfigs())'
      replace: 'factory.setConsumerFactory(DefaultKafkaConsumerFactory(latestConsumerConfigs()))'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: '.buildConsumerProperties(null)'
      replace: '.buildConsumerProperties()'

  # Kotlin Code Specific Hackz
  - org.openrewrite.text.FindAndReplace:
      find: 'response.body.'
      replace: 'response.body!!.'
      caseSensitive: true
      filePattern: '**/*.kt'

  - org.openrewrite.text.FindAndReplace: # websocket stuff
      find: 'headers -> headers.addAll(headersMap)'
      replace: 'headers -> headers.addAll(org.springframework.http.HttpHeaders.copyOf(headersMap))'
      caseSensitive: true
      filePattern: '**/*.kt'

  - org.openrewrite.text.FindAndReplace: # spring data spec usage
      filePattern: '**/*.kt'
      find: '\.and\(((?:[\w$]+\.)*[\w$]+Spec\([^)]*\))\)'
      replace: '.and($1!!)'
      regex: true

  - org.openrewrite.text.FindAndReplace: # kafka serialier
      filePattern: '**/*.kt'
      find: 'failedDeserializationInfo.headers.'
      replace: 'failedDeserializationInfo.headers!!.'

  - org.openrewrite.text.FindAndReplace: # kafka serialier
      filePattern: '**/*It.kt'
      find: 'StringDeserializer::class.qualifiedName'
      replace: 'StringDeserializer::class.qualifiedName as Any'


  # Kotlin Changetype Hackz
#  - org.openrewrite.text.FindAndReplace:
#      filePattern: '**/*.kt'
#      find: 'import org.springframework.boot.test.web.server.LocalServerPort'
#      replace: 'import org.springframework.boot.web.server.test.LocalServerPort'
#      caseSensitive: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'import org.springframework.boot.autoconfigure.flyway.FlywayMigrationStrategy'
      replace: 'import org.springframework.boot.flyway.autoconfigure.FlywayMigrationStrategy'
      caseSensitive: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'import org.springframework.boot.autoconfigure.orm.jpa.HibernatePropertiesCustomizer'
      replace: 'import org.springframework.boot.hibernate.autoconfigure.HibernatePropertiesCustomizer'
      caseSensitive: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'import org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration'
      replace: 'import org.springframework.boot.kafka.autoconfigure.KafkaAutoConfiguration'
      caseSensitive: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'import org.springframework.boot.test.web.client.TestRestTemplate'
      replace: 'import org.springframework.boot.web.server.test.client.TestRestTemplate'
      caseSensitive: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.kt'
      find: 'import org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration'
      replace: 'import org.springframework.boot.data.redis.autoconfigure.RedisAutoConfiguration'
      caseSensitive: true

  ####

  # TODO: Set DirtiesContext for Kafka (to avoid FileNotFoundException) as recommended by Spring to avoid, also causes hang when enabled ??: https://docs.spring.io/spring-kafka/reference/testing.html#embedded-broker-with-springjunitconfig-annotations
#  - org.openrewrite.text.FindAndReplace:
#      find: '@EmbeddedKafka('
#      replace: '@org.springframework.test.annotation.DirtiesContext @EmbeddedKafka('
#      filePattern: '**/*.java;**/*.kt'


  # TODO - Temp. Spring Data Fix
  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.java;**/*.kt'
      find: '(findBy\w+)IgnoreCase'
      replace: '$1'
      regex: true

#  # TODO - Fix for AotTest Compile Error
#  - org.openrewrite.text.FindAndReplace:
#      filePattern: 'build.gradle.kts'
#      find: 'rewrite { activeRecipe("UpgradeSpringBoot_4_0", "UpgradeSpringBatch_6_0") }'
#      replace: |
#        rewrite { activeRecipe("UpgradeSpringBoot_4_0", "UpgradeSpringBatch_6_0") }
#        tasks.withType<org.springframework.boot.gradle.tasks.aot.ProcessTestAot>().configureEach {  enabled = false }
#        tasks.withType<org.springframework.boot.gradle.tasks.aot.ProcessAot>().configureEach {  enabled = false }


  # TODO: spring aws s3 crap
  - org.openrewrite.text.FindAndReplace:
      filePattern: 'build.gradle.kts'
      find: 'implementation("io.awspring.cloud:spring-cloud-aws-starter-s3")'
      replace: 'implementation("software.amazon.awssdk:s3:2.31.54") //implementation("io.awspring.cloud:spring-cloud-aws-starter-s3")'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.java;**/*.kt'
      find: '@Import(AwsAutoConfiguration'
      replace: '//@Import(AwsAutoConfiguration'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.java;**/*.kt'
      find: 'import io\.awspring\.cloud\.autoconfigure\.core\.AwsAutoConfiguration;?'
      replace: ''
      regex: true

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*.java'
      find: 'S3Client s3Client) {'
      replace: '@org.springframework.beans.factory.annotation.Autowired(required = false) S3Client s3Client) {'


  # Document fix
  - org.openrewrite.text.FindAndReplace:
      find: |
        jpa.autoconfiguration: "org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration, org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration, org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration"
        mongodb.autoconfiguration: "org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration, org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration, org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration"
        elasticsearch.autoconfiguration: "org.springframework.boot.autoconfigure.elasticsearch.ElasticsearchClientAutoConfiguration, org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration, org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration, org.springframework.boot.actuate.autoconfigure.elasticsearch.ElasticsearchRestHealthContributorAutoConfiguration"
      replace: |
        jpa.autoconfiguration: "org.springframework.boot.jdbc.autoconfigure.DataSourceAutoConfiguration, org.springframework.boot.hibernate.autoconfigure.HibernateJpaAutoConfiguration, org.springframework.boot.data.jpa.autoconfigure.JpaRepositoriesAutoConfiguration"
        mongodb.autoconfiguration: "org.springframework.boot.mongodb.autoconfigure.MongoAutoConfiguration, org.springframework.boot.data.mongodb.autoconfigure.MongoDataAutoConfiguration, org.springframework.boot.data.mongodb.autoconfigure.MongoRepositoriesAutoConfiguration"
        elasticsearch.autoconfiguration: "org.springframework.boot.elasticsearch.autoconfigure.ElasticsearchClientAutoConfiguration, org.springframework.boot.data.elasticsearch.autoconfigure.ElasticsearchDataAutoConfiguration, org.springframework.boot.data.elasticsearch.autoconfigure.ElasticsearchRepositoriesAutoConfiguration, org.springframework.boot.elasticsearch.autoconfigure.health.ElasticsearchRestHealthContributorAutoConfiguration"
      filePattern: 'src/main/resources/application.yml'

---
type: specs.openrewrite.org/v1beta/recipe
name: UpgradeSpringBatch_6_0
recipeList:
  # Spring Batch Imports
  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.Step
      newFullyQualifiedTypeName: org.springframework.batch.core.step.Step

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.StepExecution
      newFullyQualifiedTypeName: org.springframework.batch.core.step.StepExecution

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.StepExecutionListener
      newFullyQualifiedTypeName: org.springframework.batch.core.listener.StepExecutionListener

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.Job
      newFullyQualifiedTypeName: org.springframework.batch.core.job.Job

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobExecution
      newFullyQualifiedTypeName: org.springframework.batch.core.job.JobExecution

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobExecutionListener
      newFullyQualifiedTypeName: org.springframework.batch.core.listener.JobExecutionListener

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobExecutionException
      newFullyQualifiedTypeName: org.springframework.batch.core.job.JobExecutionException

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobParameters
      newFullyQualifiedTypeName: org.springframework.batch.core.job.parameters.JobParameters

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.ItemWriteListener
      newFullyQualifiedTypeName: org.springframework.batch.core.listener.ItemWriteListener

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.StepContribution
      newFullyQualifiedTypeName: org.springframework.batch.core.step.StepContribution

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobParametersInvalidException
      newFullyQualifiedTypeName: org.springframework.batch.core.job.parameters.JobParametersInvalidException

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.explore.JobExplorer
      newFullyQualifiedTypeName: org.springframework.batch.core.repository.explore.JobExplorer

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.explore.support.JobExplorerFactoryBean
      newFullyQualifiedTypeName: org.springframework.batch.core.repository.explore.support.JobExplorerFactoryBean

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobParametersBuilder
      newFullyQualifiedTypeName: org.springframework.batch.core.job.parameters.JobParametersBuilder

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobParametersIncrementer
      newFullyQualifiedTypeName: org.springframework.batch.core.job.parameters.JobParametersIncrementer

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.hibernate.query.sqm.mutation.internal.temptable.BeforeUseAction
      newFullyQualifiedTypeName: org.hibernate.query.sqm.mutation.spi.BeforeUseAction

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.JobInstance
      newFullyQualifiedTypeName: org.springframework.batch.core.job.JobInstance

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.core.launch.support.RunIdIncrementer
      newFullyQualifiedTypeName: org.springframework.batch.core.job.parameters.RunIdIncrementer

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.item.ItemReader
      newFullyQualifiedTypeName: org.springframework.batch.infrastructure.item.ItemReader

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.item.ItemWriter
      newFullyQualifiedTypeName: org.springframework.batch.infrastructure.item.ItemWriter

  - org.openrewrite.java.ChangeType:
      oldFullyQualifiedTypeName: org.springframework.batch.item.file.builder.FlatFileItemReaderBuilder
      newFullyQualifiedTypeName: org.springframework.batch.infrastructure.item.file.builder.FlatFileItemReaderBuilder

  # Code specific changes
  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*BatchConfiguration.java'
      find: 'getTablePrefix()'
      replace: 'org.springframework.batch.core.repository.dao.AbstractJdbcBatchMetadataDao.DEFAULT_TABLE_PREFIX'

  - org.openrewrite.text.FindAndReplace:
      filePattern: '**/*BatchConfiguration.java'
      find: '@Override'
      replace: ''

  # Document fix
  - org.openrewrite.text.FindAndReplace:
      find: |
        mongodb.autoconfiguration: "org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration, org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration, org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration"
        jdbc.autoconfiguration: "org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration"
      replace: |
        mongodb.autoconfiguration: "org.springframework.boot.mongodb.autoconfigure.MongoAutoConfiguration, org.springframework.boot.data.mongodb.autoconfigure.MongoDataAutoConfiguration, org.springframework.boot.data.mongodb.autoconfigure.MongoRepositoriesAutoConfiguration"
        jdbc.autoconfiguration: "org.springframework.boot.data.jdbc.autoconfigure.JdbcRepositoriesAutoConfiguration"
    filePattern: 'src/main/resources/application.yml'